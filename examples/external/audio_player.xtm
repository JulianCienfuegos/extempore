;;; audio_player.xtm -- a simple audio file player example

;; Author: Ben Swift
;; Keywords: extempore
;; Required dylibs: libsndfile

;;; Commentary:

;; You should have a wave file in your assets directory called
;; assets/bb.wav - if you don't you can grab the whole assets
;; directory from http://extempore.moso.com.au/extras/assets.tgz

;;; Code:

(sys:load "libs/external/sndfile.xtm")

(bind-func dsp:DSP 20000000 ; make sure we allocate enough memory
  (let ((abuf (AudioBuffer "assets/samples/glitch.wav"))
        (frames (num_frames abuf))
        (nchan (num_channels abuf))
        (playhead 0)
        (i 0))
    (if (or (null? abuf)
            (null? (audio_data abuf)))
        (println "Error reading audio file."))
    (lambda (in time chan dat)
      ;; increment the playhead at the beginning of each frame
      (if (= chan 0)
          (set! playhead (modulo (+ playhead 1) frames)))
      (audio_sample_seek abuf playhead chan))))

;; now set the dsp closure to start the audio
(dsp:set! dsp)
