;;; opengl_101.xtm -- Simplest possible OpenGL example

;; Author: Andrew Sorensen
;; Keywords: extempore

;;; Commentary:

;;

;;; Code:

(sys:load "libs/contrib/glfw3.xtm")

(xtgl_init)
(define *xtgl-window* (xtgl_create_window_with_size_compat 1024 768))
(xtgl_make_context_current *xtgl-window*)

(bind-func my-gl-loop
  (let ((size 0.01))
    (lambda (degree)
      (glClear (+ GL_COLOR_BUFFER_BIT GL_DEPTH_BUFFER_BIT))
      (glLoadIdentity)
      (glTranslatef 0.0 -1.0 0.0)
      (let ((i 0.0))
	(dotimes (i 1000.0)
	  (glTranslatef (/ i 2000.0) 0.0 0.0)
	  (glColor3f 1.0 (/ i 1500.0) (/ (- 1000. i) 500.0))
	  (glRotatef degree (/ i 200000.0) 0.5 0.0)
	  (glBegin GL_QUADS)
	  (glVertex2f 0.0 0.0)
	  (glVertex2f (* -5. size) 0.0)
	  (glVertex2f size (* 2. size))
	  (glVertex2f 0.0 size)
	  (glEnd))))))

;; standard impromptu callback                                                
(define run-my-opengl-loop
  (lambda (degree)
    (my-gl-loop degree)
    (xtgl_swap_buffers *xtgl-window*)
    (callback (+ (now) 500) 'run-my-opengl-loop (+ degree .005))))

(run-my-opengl-loop 70.0)
